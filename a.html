<!doctype html>
<meta charset="utf-8">
<title>PPTX 文字提取（纯前端）</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<h2>1. 选 PPTX 文件</h2>
<input type="file" id="inp" accept=".pptx">
<h2>2. 结果</h2>
<pre id="out"></pre>

<script>
// 通用：从任意 xml 字符串里扫 <a:t>xxx</a:t>
function extractTexts(xml){
  const out=[];
  const pRe=/<a:p(?:\s[^>]*)?>(.*?)<\/a:p>/gs;
  const tRe=/<a:t[^>]*>([^<]*)<\/a:t>/g;
  let pm;
  while((pm=pRe.exec(xml))!==null){
    const seg=pm[1],line=[];
    let tm; tRe.lastIndex=0;
    while((tm=tRe.exec(seg))!==null) line.push(tm[1]);
    if(line.length) out.push(line.join(''));
  }
  if(!out.length){        // 没有 <a:p> 时退回到裸 <a:t>
    tRe.lastIndex=0; let tm;
    while((tm=tRe.exec(xml))!==null) out.push(tm[1]);
  }
  return out;
}

// 把 rId -> 目标文件 建成 map
function buildRelMap(relXml){
  const map={};
  const re=/Id="([^"]+)"\s+Type="[^"]+"\s+Target="([^"]+)"/g; let m;
  while((m=re.exec(relXml))!==null) map[m[1]]=m[2].slice(3);   // 去掉 ../
  return map;
}

inp.onchange=async e=>{
  const file=e.target.files[0]; if(!file)return;
  const zip=await JSZip.loadAsync(file);
  const slides=Object.keys(zip.files)
        .filter(f=>/^ppt\/slides\/slide(\d+)\.xml$/.test(f))
        .sort((a,b)=> a.match(/(\d+)/)[1]-b.match(/(\d+)/)[1] );

  const res=[];
  for(const slidePath of slides){
    const idx=+slidePath.match(/slide(\d+)\.xml/)[1];
    const slideXml=await zip.file(slidePath).async('string');
    const texts=extractTexts(slideXml);

    // 处理 rels 拿到外部引用
    const relPath=`ppt/slides/_rels/slide${idx}.xml.rels`;
    const relFile=zip.file(relPath);
    if(relFile){
      const relMap=buildRelMap(await relFile.async('string'));
      // 扫 slide 里出现的 rId
      const idRe=/(?:(<dgm:relIds[^>]*\sr:dm="([^"]+)")|(chart[^>]*r:id="([^"]+)"))/g; let m;
      const seen=new Set();
      while((m=idRe.exec(slideXml))!==null) seen.add(m[2]||m[4]);
      for(const rId of seen){
        const tgt=relMap[rId]; if(!tgt) continue;
        if(tgt.includes('diagrams/')||tgt.includes('/charts/')){
          const xml=await zip.file('ppt/'+tgt).async('string');
          texts.push(...extractTexts(xml));
        }
      }
    }
    res.push({slide:idx,texts});
  }
  out.textContent=JSON.stringify(res,null,2);
};
</script>